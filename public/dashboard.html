<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tarefas Acadêmicas</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="estilo.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0/dist/chartjs-plugin-datalabels.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jwt-decode@3.1.2/build/jwt-decode.min.js"></script>
    <script src="https://cdn.socket.io/4.5.0/socket.io.min.js"></script>
</head>
<body>
    <nav class="navbar navbar-expand-lg">
        <div class="container-fluid">
            <a class="navbar-brand" href="#">Tarefas Acadêmicas</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item"><a class="nav-link" href="#" onclick="showSection('overview')">Visão Geral</a></li>
                    <li class="nav-item"><a class="nav-link" href="#" onclick="showSection('tasks')">Tarefas</a></li>
                    <li class="nav-item"><a class="nav-link" href="#" onclick="showSection('prioritized')">Tarefas Priorizadas</a></li>
                    <li class="nav-item"><a class="nav-link" href="#" onclick="showSection('reports')">Relatórios</a></li>
                    <li class="nav-item"><a class="nav-link" href="#" onclick="showSection('support')">Suporte</a></li>
                    <li class="nav-item"><a class="nav-link" href="#" onclick="showSection('notifications')">Notificações</a></li>
                    <li class="nav-item"><a class="nav-link" href="#" onclick="logout()">Sair</a></li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container">
        <h1 class="welcome-message">Bem-vindo, <span id="userName"></span></h1>

        <div id="overview" class="section">
            <h2>Visão Geral</h2>
            <div id="overviewContent" class="loading">Carregando...</div>
            <div class="row mt-4">
                <div class="col-md-3">
                    <div class="card bg-primary text-white">
                        <div class="card-body">
                            <h5 class="card-title">Tarefas Pendentes</h5>
                            <p class="card-text" id="pendingTasks">0</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card bg-success text-white">
                        <div class="card-body">
                            <h5 class="card-title">Tarefas Concluídas</h5>
                            <p class="card-text" id="completedTasks">0</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card bg-danger text-white">
                        <div class="card-body">
                            <h5 class="card-title">Tarefas Atrasadas</h5>
                            <p class="card-text" id="overdueTasks">0</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card bg-warning text-white">
                        <div class="card-body">
                            <h5 class="card-title">Tarefas Próximas</h5>
                            <p class="card-text" id="upcomingTasks">0</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="tasks" class="section d-none">
            <h2>Tarefas</h2>
            <div id="tasksContent" class="loading">Carregando...</div>
            <button class="btn btn-primary mb-3" data-bs-toggle="modal" data-bs-target="#taskModal">Adicionar Tarefa</button>
            <div class="mb-3">
                <label for="statusFilter" class="form-label">Filtrar por Status</label>
                <select id="statusFilter" class="form-select" onchange="loadTasks()">
                    <option value="all">Todas</option>
                    <option value="Pendente">Pendente</option>
                    <option value="Em andamento">Em andamento</option>
                    <option value="Concluída">Concluída</option>
                </select>
            </div>
            <div class="table-responsive">
                <table class="table table-striped">
                    <thead>
                        <tr>
                            <th>Título</th>
                            <th>Disciplina</th>
                            <th>Data</th>
                            <th>Prioridade</th>
                            <th>Status</th>
                            <th>Ações</th>
                        </tr>
                    </thead>
                    <tbody id="tasksTable"></tbody>
                </table>
            </div>
        </div>

        <div id="prioritized" class="section d-none">
            <h2>Tarefas Priorizadas</h2>
            <div id="prioritizedContent" class="loading">Carregando...</div>
            <div class="mb-3">
                <label for="priorityFilter" class="form-label">Filtrar Tarefas</label>
                <select id="priorityFilter" class="form-select" onchange="loadPrioritizedTasks()">
                    <option value="default">Padrão (Prioridade Alta > Baixa, Data Crescente)</option>
                    <option value="dateAsc">Data de Entrega (Crescente)</option>
                    <option value="dateDesc">Data de Entrega (Decrescente)</option>
                    <option value="priorityAsc">Prioridade (Alta > Baixa)</option>
                    <option value="priorityDesc">Prioridade (Baixa > Alta)</option>
                </select>
            </div>
            <div class="table-responsive">
                <table class="table table-striped">
                    <thead>
                        <tr>
                            <th>Título</th>
                            <th>Disciplina</th>
                            <th>Data de Entrega</th>
                            <th>Prioridade</th>
                            <th>Status</th>
                            <th>Ações</th>
                        </tr>
                    </thead>
                    <tbody id="prioritizedTable"></tbody>
                </table>
            </div>
        </div>

        <div id="reports" class="section d-none">
            <h2>Relatórios</h2>
            <div id="reportsContent" class="loading">Carregando...</div>
            <div class="row mt-4">
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-body">
                            <h5 class="card-title">Tarefas por Disciplina</h5>
                            <canvas id="tasksBySubject"></canvas>
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-body">
                            <h5 class="card-title">Tipos de Tarefa</h5>
                            <canvas id="tasksByType"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="notifications" class="section d-none">
            <h2>Notificações</h2>
            <div id="notificationsContent" class="loading">Carregando...</div>
            <button class="btn btn-primary mt-3" onclick="loadNotifications()">Recarregar Notificações</button>
        </div>

        <div id="support" class="section d-none">
            <h2>Suporte</h2>
            <div id="supportContent" class="loading">Carregando...</div>
            <div class="card mt-4">
                <div class="card-body">
                    <h5 class="card-title">Chat de Suporte</h5>
                    <div class="mb-3">
                        <label for="chatRecipient" class="form-label">Enviar para</label>
                        <select id="chatRecipient" class="form-select">
                            <option value="Bot">Bot</option>
                            <option value="admin" disabled>Administrador</option>
                        </select>
                    </div>
                    <div class="chat-messages" id="chatMessages"></div>
                    <form id="chatForm" class="chat-form mt-3">
                        <div class="input-group">
                            <input type="text" id="chatInput" class="form-control" placeholder="Digite sua mensagem..." required>
                            <button type="submit" class="btn btn-primary">Enviar</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <div class="modal fade" id="taskModal" tabindex="-1" aria-labelledby="taskModalLabel" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="taskModalLabel">Adicionar Tarefa</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <form id="taskForm">
                            <div class="mb-3">
                                <label for="taskTitle" class="form-label">Título</label>
                                <input type="text" class="form-control" id="taskTitle" required>
                            </div>
                            <div class="mb-3">
                                <label for="taskType" class="form-label">Tipo</label>
                                <select class="form-select" id="taskType" required>
                                    <option value="Trabalho individual">Trabalho individual</option>
                                    <option value="Trabalho em grupo">Trabalho em grupo</option>
                                    <option value="Revisão">Revisão</option>
                                    <option value="Apresentação">Apresentação</option>
                                </select>
                            </div>
                            <div class="mb-3">
                                <label for="taskDescription" class="form-label">Descrição</label>
                                <textarea class="form-control" id="taskDescription" required></textarea>
                            </div>
                            <div class="mb-3">
                                <label for="taskDeadline" class="form-label">Data de Entrega</label>
                                <input type="date" class="form-control" id="taskDeadline" required>
                            </div>
                            <div class="mb-3">
                                <label for="taskSubject" class="form-label">Disciplina</label>
                                <input type="text" class="form-control" id="taskSubject" list="subjectList" required>
                                <datalist id="subjectList">
                                    <option value="Matemática">
                                    <option value="Programação Web">
                                    <option value="Inteligência Artificial">
                                    <option value="História">
                                    <option value="Física">
                                </datalist>
                            </div>
                            <div class="mb-3">
                                <label for="taskPriority" class="form-label">Prioridade</label>
                                <select class="form-select" id="taskPriority" required>
                                    <option value="Alta">Alta</option>
                                    <option value="Média">Média</option>
                                    <option value="Baixa">Baixa</option>
                                </select>
                            </div>
                            <div class="mb-3">
                                <label for="taskEstimatedTime" class="form-label">Tempo Estimado</label>
                                <input type="text" class="form-control" id="taskEstimatedTime" required>
                            </div>
                            <button type="submit" class="btn btn-primary">Adicionar Tarefa</button>
                        </form>
                    </div>
                </div>
            </div>
        </div>

        <div class="modal fade" id="statusModal" tabindex="-1" aria-labelledby="statusModalLabel" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="statusModalLabel">Confirmar Alteração de Status</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <p>Deseja alterar o status da tarefa "<span id="statusTaskTitle"></span>" para "<span id="statusNewStatus"></span>"?</p>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                        <button type="button" class="btn btn-primary" id="confirmStatusChange">Confirmar</button>
                    </div>
                </div>
            </div>
        </div>

        <div class="modal fade" id="viewTaskModal" tabindex="-1" aria-labelledby="viewTaskModalLabel" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="viewTaskModalLabel">Detalhes da Tarefa</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <p id="viewTaskDetails"></p>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
                    </div>
                </div>
            </div>
        </div>

        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
        <script>
            Chart.register(ChartDataLabels);
            const token = localStorage.getItem('token');
            if (!token) window.location.href = 'index.html';
            document.getElementById('userName').textContent = localStorage.getItem('userName') || 'Usuário';
            const socket = io({ auth: { token } });

            function showSection(sectionId) {
                document.querySelectorAll('.section').forEach(section => section.classList.add('d-none'));
                document.getElementById(sectionId).classList.remove('d-none');
                if (sectionId === 'tasks') loadTasks();
                if (sectionId === 'prioritized') loadPrioritizedTasks();
                if (sectionId === 'reports') loadReports();
                if (sectionId === 'support') loadChatHistory();
                if (sectionId === 'notifications') loadNotifications();
            }

            function showError(section, message) {
                document.getElementById(`${section}Content`).innerHTML = `<div class="alert alert-danger">${message}</div>`;
            }

            function debounce(func, wait) {
                let timeout;
                return function executedFunction(...args) {
                    const later = () => {
                        clearTimeout(timeout);
                        func(...args);
                    };
                    clearTimeout(timeout);
                    timeout = setTimeout(later, wait);
                };
            }

            const debouncedLoadReports = debounce(loadReports, 500);

            async function loadOverview() {
                try {
                    const response = await fetch('/api/student-overview', {
                        headers: { 'Authorization': `Bearer ${token}` }
                    });
                    if (response.status === 401 || response.status === 403) {
                        localStorage.removeItem('token');
                        window.location.href = 'index.html';
                        return;
                    }
                    if (!response.ok) throw new Error('Erro ao carregar visão geral');
                    const data = await response.json();
                    document.getElementById('pendingTasks').textContent = data.pendingTasks || 0;
                    document.getElementById('completedTasks').textContent = data.completedTasks || 0;
                    document.getElementById('overdueTasks').textContent = data.overdueTasks || 0;
                    document.getElementById('upcomingTasks').textContent = data.upcomingTasks || 0;
                    document.getElementById('overviewContent').innerHTML = '';
                } catch (error) {
                    showError('overview', error.message);
                }
            }

            async function loadTasks() {
                try {
                    const filter = document.getElementById('statusFilter').value;
                    const response = await fetch(`/api/tasks?filter=${filter}`, {
                        headers: { 'Authorization': `Bearer ${token}` }
                    });
                    if (response.status === 401 || response.status === 403) {
                        localStorage.removeItem('token');
                        window.location.href = 'index.html';
                        return;
                    }
                    if (!response.ok) throw new Error('Erro ao carregar tarefas');
                    const tasks = await response.json();
                    const tbody = document.getElementById('tasksTable');
                    tbody.innerHTML = '';
                    tasks.forEach(task => {
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td>${task.title}</td>
                            <td>${task.subject}</td>
                            <td>${task.deadline}</td>
                            <td>${task.priority}</td>
                            <td>${task.status}</td>
                            <td>
                                <button class="btn btn-primary btn-sm" onclick="confirmStatusChange('${task.id}', '${task.title}', '${task.status}')">Editar Status</button>
                                <button class="btn btn-info btn-sm" onclick="viewTask('${task.id}', '${task.title}', '${task.type}', '${task.description}', '${task.deadline}', '${task.subject}', '${task.priority}', '${task.estimatedTime}', '${task.status}')">Ver Detalhes</button>
                            </td>
                        `;
                        tbody.appendChild(row);
                    });
                    document.getElementById('tasksContent').innerHTML = tasks.length ? '' : '<div class="alert alert-info">Nenhuma tarefa encontrada</div>';
                } catch (error) {
                    showError('tasks', error.message);
                }
            }

            async function loadPrioritizedTasks() {
                try {
                    const response = await fetch('/api/tasks/prioritized', {
                        headers: { 'Authorization': `Bearer ${token}` }
                    });
                    if (response.status === 401 || response.status === 403) {
                        localStorage.removeItem('token');
                        window.location.href = 'index.html';
                        return;
                    }
                    if (response.status === 404) throw new Error('Rota de tarefas priorizadas não encontrada. Verifique o servidor.');
                    if (!response.ok) throw new Error(`Erro ao carregar tarefas priorizadas: ${response.statusText}`);
                    let tasks = await response.json();
                    const filter = document.getElementById('priorityFilter').value;

                    // Aplicar filtro
                    if (filter === 'dateAsc') {
                        tasks.sort((a, b) => {
                            const [dayA, monthA, yearA] = a.deadline.split('/');
                            const [dayB, monthB, yearB] = b.deadline.split('/');
                            return new Date(`${yearA}-${monthA}-${dayA}`) - new Date(`${yearB}-${monthB}-${dayB}`);
                        });
                    } else if (filter === 'dateDesc') {
                        tasks.sort((a, b) => {
                            const [dayA, monthA, yearA] = a.deadline.split('/');
                            const [dayB, monthB, yearB] = b.deadline.split('/');
                            return new Date(`${yearB}-${monthB}-${dayB}`) - new Date(`${yearA}-${monthA}-${dayA}`);
                        });
                    } else if (filter === 'priorityAsc') {
                        const priorityOrder = { 'Alta': 1, 'Média': 2, 'Baixa': 3 };
                        tasks.sort((a, b) => priorityOrder[a.priority] - priorityOrder[b.priority]);
                    } else if (filter === 'priorityDesc') {
                        const priorityOrder = { 'Alta': 1, 'Média': 2, 'Baixa': 3 };
                        tasks.sort((a, b) => priorityOrder[b.priority] - priorityOrder[a.priority]);
                    } else {
                        // Padrão: Prioridade Alta > Baixa, Data Crescente
                        const priorityOrder = { 'Alta': 1, 'Média': 2, 'Baixa': 3 };
                        tasks.sort((a, b) => {
                            const priorityA = priorityOrder[a.priority] || 3;
                            const priorityB = priorityOrder[b.priority] || 3;
                            if (priorityA !== priorityB) return priorityA - priorityB;
                            const [dayA, monthA, yearA] = a.deadline.split('/');
                            const [dayB, monthB, yearB] = b.deadline.split('/');
                            return new Date(`${yearA}-${monthA}-${dayA}`) - new Date(`${yearB}-${monthB}-${dayB}`);
                        });
                    }

                    const tbody = document.getElementById('prioritizedTable');
                    tbody.innerHTML = '';
                    tasks.forEach(task => {
                        const row = document.createElement('tr');
                        row.className = `priority-${task.priority.toLowerCase()}`;
                        row.innerHTML = `
                            <td>${task.title}</td>
                            <td>${task.subject}</td>
                            <td>${task.deadline}</td>
                            <td>${task.priority}</td>
                            <td>${task.status}</td>
                            <td>
                                <button class="btn btn-primary btn-sm" onclick="confirmStatusChange('${task.id}', '${task.title}', '${task.status}')">Editar Status</button>
                                <button class="btn btn-info btn-sm" onclick="viewTask('${task.id}', '${task.title}', '${task.type}', '${task.description}', '${task.deadline}', '${task.subject}', '${task.priority}', '${task.estimatedTime}', '${task.status}')">Ver Detalhes</button>
                            </td>
                        `;
                        tbody.appendChild(row);
                    });
                    document.getElementById('prioritizedContent').innerHTML = tasks.length ? '' : '<div class="alert alert-info">Nenhuma tarefa pendente</div>';
                } catch (error) {
                    console.error('Erro ao carregar tarefas priorizadas:', error);
                    showError('prioritized', error.message);
                }
            }

            function confirmStatusChange(taskId, taskTitle, currentStatus) {
                document.getElementById('statusTaskTitle').textContent = taskTitle;
                document.getElementById('statusNewStatus').innerHTML = `
                    <select id="newStatusSelect" class="form-select">
                        <option value="Pendente" ${currentStatus === 'Pendente' ? 'selected' : ''}>Pendente</option>
                        <option value="Em andamento" ${currentStatus === 'Em andamento' ? 'selected' : ''}>Em andamento</option>
                        <option value="Concluída" ${currentStatus === 'Concluída' ? 'selected' : ''}>Concluída</option>
                    </select>
                `;
                const modal = new bootstrap.Modal(document.getElementById('statusModal'));
                modal.show();
                document.getElementById('confirmStatusChange').onclick = async () => {
                    const newStatus = document.getElementById('newStatusSelect').value;
                    if (newStatus === currentStatus) {
                        modal.hide();
                        return;
                    }
                    try {
                        const response = await fetch(`/api/tasks/${taskId}`, {
                            method: 'PATCH',
                            headers: {
                                'Content-Type': 'application/json',
                                'Authorization': `Bearer ${token}`
                            },
                            body: JSON.stringify({ status: newStatus })
                        });
                        if (response.status === 401 || response.status === 403) {
                            localStorage.removeItem('token');
                            window.location.href = 'index.html';
                            return;
                        }
                        if (!response.ok) throw new Error('Erro ao atualizar status da tarefa');
                        modal.hide();
                        loadTasks();
                        loadPrioritizedTasks();
                        loadOverview();
                        loadReports();
                        socket.emit('taskUpdated', { id: taskId, status: newStatus });
                    } catch (error) {
                        showError('tasks', error.message);
                    }
                };
            }

            async function loadReports() {
                try {
                    const response = await fetch('/api/reports', {
                        headers: { 'Authorization': `Bearer ${token}` }
                    });
                    if (response.status === 401 || response.status === 403) {
                        localStorage.removeItem('token');
                        window.location.href = 'index.html';
                        return;
                    }
                    if (!response.ok) throw new Error('Erro ao carregar relatórios');
                    const data = await response.json();
                    const subjects = Object.keys(data.bySubject);
                    const subjectData = subjects.map(subject => ({
                        subject,
                        Pendente: data.bySubject[subject].Pendente || 0,
                        'Em andamento': data.bySubject[subject]['Em andamento'] || 0,
                        Concluída: data.bySubject[subject].Concluída || 0
                    }));
                    let tasksBySubjectChart = Chart.getChart('tasksBySubject');
                    if (tasksBySubjectChart) tasksBySubjectChart.destroy();
                    tasksBySubjectChart = new Chart(document.getElementById('tasksBySubject'), {
                        type: 'bar',
                        data: {
                            labels: subjects,
                            datasets: [
                                {
                                    label: 'Pendente',
                                    data: subjectData.map(d => d.Pendente),
                                    backgroundColor: '#3498db'
                                },
                                {
                                    label: 'Em andamento',
                                    data: subjectData.map(d => d['Em andamento']),
                                    backgroundColor: '#f1c40f'
                                },
                                {
                                    label: 'Concluída',
                                    data: subjectData.map(d => d.Concluída),
                                    backgroundColor: '#2ecc71'
                                }
                            ]
                        },
                        options: {
                            responsive: true,
                            scales: {
                                x: { stacked: true },
                                y: {
                                    stacked: true,
                                    beginAtZero: true,
                                    ticks: { stepSize: 1, precision: 0 }
                                }
                            },
                            plugins: { legend: { position: 'top' } }
                        }
                    });

                    const typeValues = Object.values(data.byType);
                    const totalTasks = typeValues.reduce((sum, val) => sum + val, 0);
                    let tasksByTypeChart = Chart.getChart('tasksByType');
                    if (tasksByTypeChart) tasksByTypeChart.destroy();
                    tasksByTypeChart = new Chart(document.getElementById('tasksByType'), {
                        type: 'pie',
                        data: {
                            labels: Object.keys(data.byType),
                            datasets: [{
                                data: typeValues,
                                backgroundColor: ['#3498db', '#f1c40f', '#2ecc71', '#e74c3c']
                            }]
                        },
                        options: {
                            responsive: true,
                            plugins: {
                                legend: { position: 'top' },
                                datalabels: {
                                    formatter: (value, ctx) => {
                                        if (totalTasks === 0) return '';
                                        const percentage = ((value / totalTasks) * 100).toFixed(1);
                                        return `${percentage}%`;
                                    },
                                    color: '#fff',
                                    font: { weight: 'bold' }
                                }
                            }
                        }
                    });

                    document.getElementById('reportsContent').innerHTML = '';
                } catch (error) {
                    showError('reports', error.message);
                }
            }

            async function loadNotifications() {
                try {
                    const response = await fetch('/api/notifications', {
                        headers: { 'Authorization': `Bearer ${token}` }
                    });
                    if (response.status === 401 || response.status === 403) {
                        localStorage.removeItem('token');
                        window.location.href = 'index.html';
                        return;
                    }
                    if (!response.ok) throw new Error('Erro ao carregar notificações');
                    const notifications = await response.json();
                    const content = document.getElementById('notificationsContent');
                    content.innerHTML = '';
                    if (notifications.length) {
                        const ul = document.createElement('ul');
                        ul.className = 'list-group';
                        notifications.forEach(n => {
                            const li = document.createElement('li');
                            li.className = 'list-group-item';
                            li.innerHTML = `<strong>${new Date(n.timestamp).toLocaleString()}</strong>: ${n.message}`;
                            ul.appendChild(li);
                        });
                        content.appendChild(ul);
                    } else {
                        content.innerHTML = '<div class="alert alert-info">Nenhuma notificação</div>';
                    }
                } catch (error) {
                    showError('notifications', error.message);
                }
            }

            async function loadChatHistory() {
                try {
                    const recipient = document.getElementById('chatRecipient').value;
                    const response = await fetch(`/api/chats?username=${recipient}`, {
                        headers: { 'Authorization': `Bearer ${token}` }
                    });
                    if (response.status === 401 || response.status === 403) {
                        localStorage.removeItem('token');
                        window.location.href = 'index.html';
                        return;
                    }
                    if (!response.ok) throw new Error('Erro ao carregar histórico de chat');
                    const chats = await response.json();
                    const chatMessages = document.getElementById('chatMessages');
                    chatMessages.innerHTML = '';
                    chats.forEach(chat => {
                        const div = document.createElement('div');
                        div.className = `message ${chat.from === jwt_decode(token).username ? 'message-user' : 'message-admin'}`;
                        div.innerHTML = `
                            <div class="message-content">
                                <strong>${chat.from}</strong>
                                <p>${chat.message}</p>
                                <span class="message-timestamp">${new Date(chat.timestamp).toLocaleString()}</span>
                            </div>
                        `;
                        chatMessages.appendChild(div);
                    });
                    chatMessages.scrollTop = chatMessages.scrollHeight;
                    document.getElementById('supportContent').innerHTML = '';
                } catch (error) {
                    showError('support', error.message);
                }
            }

            function viewTask(id, title, type, description, deadline, subject, priority, estimatedTime, status) {
                document.getElementById('viewTaskDetails').innerHTML = `
                    <strong>Título:</strong> ${title}<br>
                    <strong>Tipo:</strong> ${type}<br>
                    <strong>Descrição:</strong> ${description}<br>
                    <strong>Data de Entrega:</strong> ${deadline}<br>
                    <strong>Disciplina:</strong> ${subject}<br>
                    <strong>Prioridade:</strong> ${priority}<br>
                    <strong>Tempo Estimado:</strong> ${estimatedTime}<br>
                    <strong>Status:</strong> ${status}
                `;
                const modal = new bootstrap.Modal(document.getElementById('viewTaskModal'));
                modal.show();
            }

            document.getElementById('taskForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                const task = {
                    title: document.getElementById('taskTitle').value,
                    type: document.getElementById('taskType').value,
                    description: document.getElementById('taskDescription').value,
                    deadline: document.getElementById('taskDeadline').value,
                    subject: document.getElementById('taskSubject').value,
                    priority: document.getElementById('taskPriority').value,
                    estimatedTime: document.getElementById('taskEstimatedTime').value
                };
                try {
                    const response = await fetch('/api/tasks', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${token}`
                        },
                        body: JSON.stringify(task)
                    });
                    if (response.status === 401 || response.status === 403) {
                        localStorage.removeItem('token');
                        window.location.href = 'index.html';
                        return;
                    }
                    if (!response.ok) throw new Error('Erro ao adicionar tarefa');
                    document.getElementById('taskForm').reset();
                    bootstrap.Modal.getInstance(document.getElementById('taskModal')).hide();
                    loadTasks();
                    loadPrioritizedTasks();
                    loadOverview();
                    loadReports();
                    socket.emit('newTask', task);
                } catch (error) {
                    showError('tasks', error.message);
                }
            });

            document.getElementById('chatForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                const message = document.getElementById('chatInput').value;
                const to = document.getElementById('chatRecipient').value;
                if (!message.trim()) return;
                const timestamp = new Date().toISOString();
                try {
                    const response = await fetch('/api/chats', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${token}`
                        },
                        body: JSON.stringify({ message, to, timestamp })
                    });
                    if (response.status === 401 || response.status === 403) {
                        localStorage.removeItem('token');
                        window.location.href = 'index.html';
                        return;
                    }
                    if (!response.ok) throw new Error('Erro ao enviar mensagem');
                    socket.emit('chatMessage', { message, to, timestamp });
                    document.getElementById('chatInput').value = '';
                    loadChatHistory();
                    if (to === 'admin') {
                        socket.emit('requestAdmin', { from: jwt_decode(token).username });
                    }
                } catch (error) {
                    showError('support', error.message);
                }
            });

            document.getElementById('chatRecipient').addEventListener('change', () => {
                loadChatHistory();
            });

            socket.on('authenticated', () => {
                console.log('Autenticado no Socket.IO');
                loadChatHistory();
            });

            socket.on('chatMessage', (data) => {
                const currentRecipient = document.getElementById('chatRecipient').value;
                if (data.from === currentRecipient || data.to === currentRecipient) {
                    loadChatHistory();
                }
            });

            socket.on('botLimitReached', () => {
                document.getElementById('supportContent').innerHTML = '<div class="alert alert-info">Limite de interações com o bot atingido. Redirecionando para o administrador...</div>';
                const recipientSelect = document.getElementById('chatRecipient');
                recipientSelect.value = 'admin';
                recipientSelect.querySelector('option[value="admin"]').disabled = false;
                setTimeout(() => {
                    document.getElementById('supportContent').innerHTML = '';
                    loadChatHistory();
                }, 2000);
            });

            socket.on('error', (error) => {
                console.error('Erro de conexão Socket.IO:', error);
                showError('support', error.message || 'Erro de conexão com o servidor de chat');
            });

            socket.on('newTask', (task) => {
                loadTasks();
                loadPrioritizedTasks();
                loadOverview();
                loadReports();
            });

            socket.on('taskUpdated', (task) => {
                loadTasks();
                loadPrioritizedTasks();
                loadOverview();
                loadReports();
            });

            socket.on('newNotification', (notification) => {
                if (document.getElementById('notifications').classList.contains('d-none')) return;
                loadNotifications();
            });

            function logout() {
                localStorage.removeItem('token');
                localStorage.removeItem('userName');
                window.location.href = 'index.html';
            }

            loadOverview();
            loadTasks();
            loadReports();
            loadNotifications();
        </script>
    </body>
</html>