<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tarefas Acadêmicas</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="estilo.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0/dist/chartjs-plugin-datalabels.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jwt-decode@3.1.2/build/jwt-decode.min.js"></script>
    <script src="https://cdn.socket.io/4.5.0/socket.io.min.js"></script>
</head>
<body>
    <nav class="navbar navbar-expand-lg">
        <div class="container-fluid">
            <a class="navbar-brand" href="#">Tarefas Acadêmicas</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item"><a class="nav-link" href="#" onclick="showSection('overview')">Visão Geral</a></li>
                    <li class="nav-item"><a class="nav-link" href="#" onclick="showSection('tasks')">Gerenciar Tarefas</a></li>
                    <li class="nav-item"><a class="nav-link" href="#" onclick="showSection('admins')">Gerenciar Administradores</a></li>
                    <li class="nav-item"><a class="nav-link" href="#" onclick="showSection('reports')">Relatórios</a></li>
                    <li class="nav-item"><a class="nav-link" href="#" onclick="showSection('support')">Suporte</a></li>
                    <li class="nav-item"><a class="nav-link" href="#" onclick="showSection('notifications')">Notificações</a></li>
                    <li class="nav-item"><a class="nav-link" href="#" onclick="logout()">Sair</a></li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container">
        <h1 class="welcome-message">Bem-vindo, <span id="userName"></span></h1>

        <div id="overview" class="section">
            <h2>Visão Geral</h2>
            <div id="overviewContent" class="loading">Carregando...</div>
            <div class="row mt-4">
                <div class="col-md-3">
                    <div class="card bg-primary text-white">
                        <div class="card-body">
                            <h5 class="card-title">Total de Tarefas</h5>
                            <p class="card-text" id="totalTasks">0</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card bg-warning text-white">
                        <div class="card-body">
                            <h5 class="card-title">Tarefas Pendentes</h5>
                            <p class="card-text" id="pendingTasks">0</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card bg-danger text-white">
                        <div class="card-body">
                            <h5 class="card-title">Tarefas Atrasadas</h5>
                            <p class="card-text" id="overdueTasks">0</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card bg-success text-white">
                        <div class="card-body">
                            <h5 class="card-title">Alunos Ativos</h5>
                            <p class="card-text" id="activeStudents">0</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="tasks" class="section d-none">
            <h2>Gerenciar Tarefas</h2>
            <div id="tasksContent" class="loading">Carregando...</div>
            <button class="btn btn-primary mb-3" data-bs-toggle="modal" data-bs-target="#taskModal">Adicionar Tarefa</button>
            <div class="table-responsive">
                <table class="table table-striped">
                    <thead>
                        <tr>
                            <th>Título</th>
                            <th>Disciplina</th>
                            <th>Data</th>
                            <th>Prioridade</th>
                            <th>Status</th>
                            <th>Ações</th>
                        </tr>
                    </thead>
                    <tbody id="tasksTable"></tbody>
                </table>
            </div>
        </div>

        <div id="admins" class="section d-none">
            <h2>Gerenciar Administradores</h2>
            <div id="adminsContent"></div>
            <button class="btn btn-primary mb-3" data-bs-toggle="modal" data-bs-target="#adminModal">Adicionar Administrador</button>
            <div class="table-responsive">
                <table class="table table-striped">
                    <thead>
                        <tr>
                            <th>Nome</th>
                            <th>Usuário</th>
                            <th>Ações</th>
                        </tr>
                    </thead>
                    <tbody id="adminsTable"></tbody>
                </table>
            </div>
        </div>

        <div id="reports" class="section d-none">
            <h2>Relatórios</h2>
            <div id="reportsContent" class="loading">Carregando...</div>
            <div class="row mt-4">
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-body">
                            <h5 class="card-title">Desempenho dos Alunos</h5>
                            <canvas id="studentPerformance"></canvas>
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-body">
                            <h5 class="card-title">Tipos de Tarefa</h5>
                            <canvas id="tasksByType"></canvas>
                        </div>
                    </div>
                </div>
                <div class="col-md-6 mt-4">
                    <div class="card">
                        <div class="card-body">
                            <h5 class="card-title">Tarefas por Disciplina</h5>
                            <canvas id="tasksByDiscipline"></canvas>
                        </div>
                    </div>
                </div>
                <div class="col-md-6 mt-4">
                    <div class="card">
                        <div class="card-body">
                            <h5 class="card-title">Tarefas por Mês</h5>
                            <canvas id="tasksByMonth"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="notifications" class="section d-none">
            <h2>Notificações</h2>
            <div id="notificationsContent" class="loading">Carregando...</div>
            <button class="btn btn-primary mt-3" onclick="loadNotifications()">Recarregar Notificações</button>
        </div>

        <div id="support" class="section d-none">
            <h2>Suporte aos Usuários</h2>
            <div id="supportContent"></div>
            <div class="card mt-4">
                <div class="card-body">
                    <h5 class="card-title">Conversas Ativas</h5>
                    <ul class="nav nav-tabs" id="chatTabs"></ul>
                    <div class="chat-messages" id="chatMessages"></div>
                    <div class="input-group mt-3">
                        <input type="text" id="chatInput" class="form-control" placeholder="Digite sua mensagem..." required>
                        <button class="btn btn-primary" onclick="sendChatMessage()">Enviar</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="taskModal" tabindex="-1" aria-labelledby="taskModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="taskModalLabel">Adicionar Tarefa</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="taskForm">
                        <div class="mb-3">
                            <label for="taskTitle" class="form-label">Título</label>
                            <input type="text" class="form-control" id="taskTitle" required>
                        </div>
                        <div class="mb-3">
                            <label for="taskType" class="form-label">Tipo</label>
                            <select class="form-select" id="taskType" required>
                                <option value="Trabalho individual">Trabalho individual</option>
                                <option value="Trabalho em grupo">Trabalho em grupo</option>
                                <option value="Revisão">Revisão</option>
                                <option value="Apresentação">Apresentação</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="taskDescription" class="form-label">Descrição</label>
                            <textarea class="form-control" id="taskDescription" required></textarea>
                        </div>
                        <div class="mb-3">
                            <label for="taskDeadline" class="form-label">Data de Entrega</label>
                            <input type="date" class="form-control" id="taskDeadline" required>
                        </div>
                        <div class="mb-3">
                            <label for="taskSubject" class="form-label">Disciplina</label>
                            <input type="text" class="form-control" id="taskSubject" list="subjectList" required>
                            <datalist id="subjectList">
                                <option value="Matemática">
                                <option value="Programação Web">
                                <option value="Inteligência Artificial">
                                <option value="História">
                                <option value="Física">
                            </datalist>
                        </div>
                        <div class="mb-3">
                            <label for="taskPriority" class="form-label">Prioridade</label>
                            <select class="form-select" id="taskPriority" required>
                                <option value="Alta">Alta</option>
                                <option value="Média">Média</option>
                                <option value="Baixa">Baixa</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="taskEstimatedTime" class="form-label">Tempo Estimado</label>
                            <input type="text" class="form-control" id="taskEstimatedTime" required>
                        </div>
                        <div class="mb-3">
                            <label for="taskUserId" class="form-label">Aluno</label>
                            <select class="form-select" id="taskUserId" required>
                                <!-- Preenchido dinamicamente -->
                            </select>
                        </div>
                        <button type="submit" class="btn btn-primary">Adicionar Tarefa</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="editTaskModal" tabindex="-1" aria-labelledby="editTaskModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="editTaskModalLabel">Editar Tarefa</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="editTaskForm">
                        <input type="hidden" id="editTaskId">
                        <div class="mb-3">
                            <label for="editTaskTitle" class="form-label">Título</label>
                            <input type="text" class="form-control" id="editTaskTitle" required>
                        </div>
                        <div class="mb-3">
                            <label for="editTaskType" class="form-label">Tipo</label>
                            <select class="form-select" id="editTaskType" required>
                                <option value="Trabalho individual">Trabalho individual</option>
                                <option value="Trabalho em grupo">Trabalho em grupo</option>
                                <option value="Revisão">Revisão</option>
                                <option value="Apresentação">Apresentação</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="editTaskDescription" class="form-label">Descrição</label>
                            <textarea class="form-control" id="editTaskDescription" required></textarea>
                        </div>
                        <div class="mb-3">
                            <label for="editTaskDeadline" class="form-label">Data de Entrega</label>
                            <input type="date" class="form-control" id="editTaskDeadline" required>
                        </div>
                        <div class="mb-3">
                            <label for="editTaskSubject" class="form-label">Disciplina</label>
                            <input type="text" class="form-control" id="editTaskSubject" list="subjectList" required>
                            <datalist id="subjectList">
                                <option value="Matemática">
                                <option value="Programação Web">
                                <option value="Inteligência Artificial">
                                <option value="História">
                                <option value="Física">
                            </datalist>
                        </div>
                        <div class="mb-3">
                            <label for="editTaskPriority" class="form-label">Prioridade</label>
                            <select class="form-select" id="editTaskPriority" required>
                                <option value="Alta">Alta</option>
                                <option value="Média">Média</option>
                                <option value="Baixa">Baixa</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="editTaskEstimatedTime" class="form-label">Tempo Estimado</label>
                            <input type="text" class="form-control" id="editTaskEstimatedTime" required>
                        </div>
                        <div class="mb-3">
                            <label for="editTaskStatus" class="form-label">Status</label>
                            <select class="form-select" id="editTaskStatus" required>
                                <option value="Pendente">Pendente</option>
                                <option value="Em andamento">Em andamento</option>
                                <option value="Concluída">Concluída</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="editTaskUserId" class="form-label">Aluno</label>
                            <select class="form-select" id="editTaskUserId" required>
                                <!-- Preenchido dinamicamente -->
                            </select>
                        </div>
                        <button type="submit" class="btn btn-primary">Salvar Alterações</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="adminModal" tabindex="-1" aria-labelledby="adminModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="adminModalLabel">Adicionar Administrador</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="adminForm">
                        <div class="mb-3">
                            <label for="adminName" class="form-label">Nome</label>
                            <input type="text" class="form-control" id="adminName" required>
                        </div>
                        <div class="mb-3">
                            <label for="adminUsername" class="form-label">Usuário</label>
                            <input type="text" class="form-control" id="adminUsername" required>
                        </div>
                        <div class="mb-3">
                            <label for="adminPassword" class="form-label">Senha</label>
                            <input type="password" class="form-control" id="adminPassword" required>
                        </div>
                        <button type="submit" class="btn btn-primary">Adicionar Administrador</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="confirmModal" tabindex="-1" aria-labelledby="confirmModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="confirmModalLabel">Confirmação</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p id="confirmMessage"></p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-primary" id="confirmAction">Confirmar</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        Chart.register(ChartDataLabels);
        const token = localStorage.getItem('token');
        if (!token) window.location.href = 'index.html';
        document.getElementById('userName').textContent = localStorage.getItem('userName') || 'Usuário';
        const socket = io({ auth: { token } });

        function showSection(sectionId) {
            document.querySelectorAll('.section').forEach(section => section.classList.add('d-none'));
            document.getElementById(sectionId).classList.remove('d-none');
            if (sectionId === 'tasks') loadTasks();
            if (sectionId === 'admins') loadAdmins();
            if (sectionId === 'reports') loadReports();
            if (sectionId === 'support') loadChatTabs();
            if (sectionId === 'notifications') loadNotifications();
        }

        function showError(section, message) {
            document.getElementById(`${section}Content`).innerHTML = `<div class="alert alert-danger">${message}</div>`;
        }

        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        const debouncedLoadReports = debounce(loadReports, 500);

        async function loadOverview() {
            try {
                const response = await fetch('/api/admin-overview', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                if (response.status === 401 || response.status === 403) {
                    localStorage.removeItem('token');
                    window.location.href = 'index.html';
                    return;
                }
                if (!response.ok) throw new Error('Erro ao carregar visão geral');
                const data = await response.json();
                document.getElementById('totalTasks').textContent = data.totalTasks || 0;
                document.getElementById('pendingTasks').textContent = data.pendingTasks || 0;
                document.getElementById('overdueTasks').textContent = data.overdueTasks || 0;
                document.getElementById('activeStudents').textContent = data.activeStudents || 0;
                document.getElementById('overviewContent').innerHTML = '';
            } catch (error) {
                showError('overview', error.message);
            }
        }

        async function loadTasks() {
            try {
                const response = await fetch('/api/admin/tasks', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                if (response.status === 401 || response.status === 403) {
                    localStorage.removeItem('token');
                    window.location.href = 'index.html';
                    return;
                }
                if (!response.ok) throw new Error('Erro ao carregar tarefas');
                const tasks = await response.json();
                const tbody = document.getElementById('tasksTable');
                tbody.innerHTML = '';
                tasks.forEach(task => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${task.title}</td>
                        <td>${task.subject}</td>
                        <td>${task.deadline}</td>
                        <td>${task.priority}</td>
                        <td>${task.status}</td>
                        <td>
                            <button class="btn btn-primary btn-sm" onclick="editTask('${task.id}', '${task.title}', '${task.type}', '${task.description}', '${task.deadline}', '${task.subject}', '${task.priority}', '${task.estimatedTime}', '${task.status}', '${task.userId}')">Editar</button>
                            <button class="btn btn-danger btn-sm" onclick="confirmDelete('${task.id}')">Excluir</button>
                        </td>
                    `;
                    tbody.appendChild(row);
                });
                document.getElementById('tasksContent').innerHTML = tasks.length ? '' : '<div class="alert alert-info">Nenhuma tarefa encontrada</div>';
            } catch (error) {
                showError('tasks', error.message);
            }
        }

        async function loadAdmins() {
            try {
                const response = await fetch('/api/admin/admins', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                if (response.status === 401 || response.status === 403) {
                    localStorage.removeItem('token');
                    window.location.href = 'index.html';
                    return;
                }
                if (!response.ok) throw new Error('Erro ao carregar administradores');
                const admins = await response.json();
                const tbody = document.getElementById('adminsTable');
                tbody.innerHTML = '';
                if (admins.length) {
                    admins.forEach(admin => {
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td>${admin.name}</td>
                            <td>${admin.username}</td>
                            <td>
                                <button class="btn btn-danger btn-sm" onclick="confirmDeleteAdmin('${admin.id}')">Excluir</button>
                            </td>
                        `;
                        tbody.appendChild(row);
                    });
                } else {
                    tbody.innerHTML = '<tr><td colspan="3" class="text-center">Nenhum administrador encontrado</td></tr>';
                }
                document.getElementById('adminsContent').innerHTML = '';
            } catch (error) {
                showError('admins', error.message);
            }
        }

        async function loadReports() {
            try {
                const [studentsRes, typesRes, disciplinesRes, monthlyRes] = await Promise.all([
                    fetch('/api/admin/reports/students', { headers: { 'Authorization': `Bearer ${token}` } }),
                    fetch('/api/admin/reports/task-types', { headers: { 'Authorization': `Bearer ${token}` } }),
                    fetch('/api/admin/reports/disciplines', { headers: { 'Authorization': `Bearer ${token}` } }),
                    fetch('/api/admin/reports/monthly', { headers: { 'Authorization': `Bearer ${token}` } })
                ]);
                if ([studentsRes, typesRes, disciplinesRes, monthlyRes].some(res => res.status === 401 || res.status === 403)) {
                    localStorage.removeItem('token');
                    window.location.href = 'index.html';
                    return;
                }
                if (!studentsRes.ok || !typesRes.ok || !disciplinesRes.ok || !monthlyRes.ok) {
                    throw new Error('Erro ao carregar relatórios');
                }
                const [students, types, disciplines, monthly] = await Promise.all([
                    studentsRes.json(),
                    typesRes.json(),
                    disciplinesRes.json(),
                    monthlyRes.json()
                ]);

                const filteredStudents = students.filter(s => s.completedTasks > 0 || s.pendingTasks > 0);
                let studentPerformanceChart = Chart.getChart('studentPerformance');
                if (studentPerformanceChart) studentPerformanceChart.destroy();
                studentPerformanceChart = new Chart(document.getElementById('studentPerformance'), {
                    type: 'bar',
                    data: {
                        labels: filteredStudents.map(s => s.name),
                        datasets: [
                            {
                                label: 'Concluídas',
                                data: filteredStudents.map(s => s.completedTasks),
                                backgroundColor: '#2ecc71'
                            },
                            {
                                label: 'Pendentes',
                                data: filteredStudents.map(s => s.pendingTasks),
                                backgroundColor: '#3498db'
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: { stepSize: 1, precision: 0 }
                            }
                        },
                        plugins: { legend: { position: 'top' } }
                    }
                });

                const typeValues = Object.values(types.byType);
                const totalTasks = typeValues.reduce((sum, val) => sum + val, 0);
                let tasksByTypeChart = Chart.getChart('tasksByType');
                if (tasksByTypeChart) tasksByTypeChart.destroy();
                tasksByTypeChart = new Chart(document.getElementById('tasksByType'), {
                    type: 'pie',
                    data: {
                        labels: Object.keys(types.byType),
                        datasets: [{
                            data: typeValues,
                            backgroundColor: ['#3498db', '#f1c40f', '#2ecc71', '#e74c3c']
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            legend: { position: 'top' },
                            datalabels: {
                                formatter: (value, ctx) => {
                                    if (totalTasks === 0) return '';
                                    const percentage = ((value / totalTasks) * 100).toFixed(1);
                                    return `${percentage}%`;
                                },
                                color: '#fff',
                                font: { weight: 'bold' }
                            }
                        }
                    }
                });

                const subjects = Object.keys(disciplines);
                const disciplineData = subjects.map(subject => ({
                    subject,
                    Pendente: disciplines[subject].Pendente || 0,
                    'Em andamento': disciplines[subject]['Em andamento'] || 0,
                    Concluída: disciplines[subject].Concluída || 0
                }));
                let tasksByDisciplineChart = Chart.getChart('tasksByDiscipline');
                if (tasksByDisciplineChart) tasksByDisciplineChart.destroy();
                tasksByDisciplineChart = new Chart(document.getElementById('tasksByDiscipline'), {
                    type: 'bar',
                    data: {
                        labels: subjects,
                        datasets: [
                            {
                                label: 'Pendente',
                                data: disciplineData.map(d => d.Pendente),
                                backgroundColor: '#3498db'
                            },
                            {
                                label: 'Em andamento',
                                data: disciplineData.map(d => d['Em andamento']),
                                backgroundColor: '#f1c40f'
                            },
                            {
                                label: 'Concluída',
                                data: disciplineData.map(d => d.Concluída),
                                backgroundColor: '#2ecc71'
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        scales: {
                            x: { stacked: true },
                            y: {
                                stacked: true,
                                beginAtZero: true,
                                ticks: { stepSize: 1, precision: 0 }
                            }
                        },
                        plugins: { legend: { position: 'top' } }
                    }
                });

                const months = Object.keys(monthly);
                const taskCounts = Object.values(monthly);
                let tasksByMonthChart = Chart.getChart('tasksByMonth');
                if (tasksByMonthChart) tasksByMonthChart.destroy();
                tasksByMonthChart = new Chart(document.getElementById('tasksByMonth'), {
                    type: 'bar',
                    data: {
                        labels: months,
                        datasets: [{
                            label: 'Tarefas',
                            data: taskCounts,
                            backgroundColor: '#3498db'
                        }]
                    },
                    options: {
                        responsive: true,
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: { stepSize: 1, precision: 0 }
                            }
                        },
                        plugins: { legend: { position: 'top' } }
                    }
                });

                document.getElementById('reportsContent').innerHTML = '';
            } catch (error) {
                showError('reports', error.message);
            }
        }

        async function loadNotifications() {
            try {
                const response = await fetch('/api/notifications', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                if (response.status === 401 || response.status === 403) {
                    localStorage.removeItem('token');
                    window.location.href = 'index.html';
                    return;
                }
                if (!response.ok) throw new Error('Erro ao carregar notificações');
                const notifications = await response.json();
                const content = document.getElementById('notificationsContent');
                content.innerHTML = '';
                if (notifications.length) {
                    const ul = document.createElement('ul');
                    ul.className = 'list-group';
                    notifications.forEach(n => {
                        const li = document.createElement('li');
                        li.className = 'list-group-item';
                        li.innerHTML = `<strong>${new Date(n.timestamp).toLocaleString()}</strong>: ${n.message}`;
                        ul.appendChild(li);
                    });
                    content.appendChild(ul);
                } else {
                    content.innerHTML = '<div class="alert alert-info">Nenhuma notificação</div>';
                }
            } catch (error) {
                showError('notifications', error.message);
            }
        }

        async function loadChatTabs() {
            const tabs = document.getElementById('chatTabs');
            tabs.innerHTML = '';
            document.getElementById('supportContent').innerHTML = '<div class="alert alert-info">Nenhum aluno solicitou suporte</div>';
            document.getElementById('chatMessages').innerHTML = '';
            localStorage.removeItem('currentChatRecipient');
        }

        async function loadChatHistory(username) {
            try {
                const response = await fetch(`/api/chats?username=${username}`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                if (response.status === 401 || response.status === 403) {
                    localStorage.removeItem('token');
                    window.location.href = 'index.html';
                    return;
                }
                if (!response.ok) throw new Error('Erro ao carregar histórico de chat');
                const chats = await response.json();
                const chatMessages = document.getElementById('chatMessages');
                chatMessages.innerHTML = '';
                chats.forEach(chat => {
                    const div = document.createElement('div');
                    div.className = `message ${chat.from === jwt_decode(token).username ? 'message-user' : 'message-admin'}`;
                    div.innerHTML = `
                        <div class="message-content">
                            <strong>${chat.from}</strong>
                            <p>${chat.message}</p>
                            <span class="message-timestamp">${new Date(chat.timestamp).toLocaleString()}</span>
                        </div>
                    `;
                    chatMessages.appendChild(div);
                });
                chatMessages.scrollTop = chatMessages.scrollHeight;
                document.querySelectorAll('#chatTabs .nav-link').forEach(tab => {
                    tab.classList.remove('active');
                    if (tab.textContent === username || tab.textContent === document.querySelector(`#chatTabs a[href*="${username}"]`)?.textContent) {
                        tab.classList.add('active');
                    }
                });
                document.getElementById('supportContent').innerHTML = '';
                localStorage.setItem('currentChatRecipient', username);
            } catch (error) {
                showError('support', error.message);
            }
        }

        async function sendChatMessage() {
            const message = document.getElementById('chatInput').value;
            const to = localStorage.getItem('currentChatRecipient');
            if (!message.trim() || !to) return;
            const timestamp = new Date().toISOString();
            try {
                const response = await fetch('/api/chats', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({ message, to, timestamp })
                });
                if (response.status === 401 || response.status === 403) {
                    localStorage.removeItem('token');
                    window.location.href = 'index.html';
                    return;
                }
                if (!response.ok) throw new Error('Erro ao enviar mensagem');
                socket.emit('chatMessage', { message, to, timestamp });
                document.getElementById('chatInput').value = '';
                loadChatHistory(to);
            } catch (error) {
                showError('support', error.message);
            }
        }

        async function loadStudentsForTask() {
            try {
                const response = await fetch('/api/users/students', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                if (!response.ok) throw new Error('Erro ao carregar alunos');
                const students = await response.json();
                const taskUserId = document.getElementById('taskUserId');
                const editTaskUserId = document.getElementById('editTaskUserId');
                taskUserId.innerHTML = '<option value="">Selecione um aluno</option>';
                editTaskUserId.innerHTML = '<option value="">Selecione um aluno</option>';
                students.forEach(student => {
                    const option = document.createElement('option');
                    option.value = student.id;
                    option.textContent = student.name;
                    taskUserId.appendChild(option);
                    editTaskUserId.appendChild(option.cloneNode(true));
                });
            } catch (error) {
                console.error('Erro ao carregar alunos:', error);
            }
        }

        document.getElementById('taskForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const task = {
                title: document.getElementById('taskTitle').value,
                type: document.getElementById('taskType').value,
                description: document.getElementById('taskDescription').value,
                deadline: document.getElementById('taskDeadline').value,
                subject: document.getElementById('taskSubject').value,
                priority: document.getElementById('taskPriority').value,
                estimatedTime: document.getElementById('taskEstimatedTime').value,
                userId: document.getElementById('taskUserId').value
            };
            try {
                const response = await fetch('/api/tasks', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify(task)
                });
                if (response.status === 401 || response.status === 403) {
                    localStorage.removeItem('token');
                    window.location.href = 'index.html';
                    return;
                }
                if (!response.ok) throw new Error('Erro ao adicionar tarefa');
                document.getElementById('taskForm').reset();
                bootstrap.Modal.getInstance(document.getElementById('taskModal')).hide();
                loadTasks();
                loadOverview();
                loadReports();
                socket.emit('newTask', task);
            } catch (error) {
                showError('tasks', error.message);
            }
        });

        document.getElementById('editTaskForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const task = {
                id: document.getElementById('editTaskId').value,
                title: document.getElementById('editTaskTitle').value,
                type: document.getElementById('editTaskType').value,
                description: document.getElementById('editTaskDescription').value,
                deadline: document.getElementById('editTaskDeadline').value,
                subject: document.getElementById('editTaskSubject').value,
                priority: document.getElementById('editTaskPriority').value,
                estimatedTime: document.getElementById('editTaskEstimatedTime').value,
                status: document.getElementById('editTaskStatus').value,
                userId: document.getElementById('editTaskUserId').value
            };
            try {
                const response = await fetch(`/api/tasks/${task.id}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify(task)
                });
                if (response.status === 401 || response.status === 403) {
                    localStorage.removeItem('token');
                    window.location.href = 'index.html';
                    return;
                }
                if (!response.ok) throw new Error('Erro ao editar tarefa');
                bootstrap.Modal.getInstance(document.getElementById('editTaskModal')).hide();
                loadTasks();
                loadOverview();
                loadReports();
                socket.emit('taskUpdated', task);
            } catch (error) {
                showError('tasks', error.message);
            }
        });

        document.getElementById('adminForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const admin = {
                name: document.getElementById('adminName').value,
                username: document.getElementById('adminUsername').value,
                password: document.getElementById('adminPassword').value,
                role: 'admin'
            };
            try {
                const response = await fetch('/api/admin/admins', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify(admin)
                });
                if (response.status === 401 || response.status === 403) {
                    localStorage.removeItem('token');
                    window.location.href = 'index.html';
                    return;
                }
                if (!response.ok) throw new Error('Erro ao adicionar administrador');
                document.getElementById('adminForm').reset();
                bootstrap.Modal.getInstance(document.getElementById('adminModal')).hide();
                loadAdmins();
            } catch (error) {
                showError('admins', error.message);
            }
        });

        function editTask(id, title, type, description, deadline, subject, priority, estimatedTime, status, userId) {
            document.getElementById('editTaskId').value = id;
            document.getElementById('editTaskTitle').value = title;
            document.getElementById('editTaskType').value = type;
            document.getElementById('editTaskDescription').value = description;
            document.getElementById('editTaskDeadline').value = deadline;
            document.getElementById('editTaskSubject').value = subject;
            document.getElementById('editTaskPriority').value = priority;
            document.getElementById('editTaskEstimatedTime').value = estimatedTime;
            document.getElementById('editTaskStatus').value = status;
            document.getElementById('editTaskUserId').value = userId;
            const modal = new bootstrap.Modal(document.getElementById('editTaskModal'));
            modal.show();
        }

        function confirmDelete(id) {
            document.getElementById('confirmMessage').textContent = 'Deseja realmente excluir esta tarefa?';
            const modal = new bootstrap.Modal(document.getElementById('confirmModal'));
            modal.show();
            document.getElementById('confirmAction').onclick = async () => {
                try {
                    const response = await fetch(`/api/tasks/${id}`, {
                        method: 'DELETE',
                        headers: { 'Authorization': `Bearer ${token}` }
                    });
                    if (response.status === 401 || response.status === 403) {
                        localStorage.removeItem('token');
                        window.location.href = 'index.html';
                        return;
                    }
                    if (!response.ok) throw new Error('Erro ao excluir tarefa');
                    modal.hide();
                    loadTasks();
                    loadOverview();
                    loadReports();
                    socket.emit('taskUpdated', { id });
                } catch (error) {
                    showError('tasks', error.message);
                }
            };
        }

        function confirmDeleteAdmin(id) {
            document.getElementById('confirmMessage').textContent = 'Deseja realmente excluir este administrador?';
            const modal = new bootstrap.Modal(document.getElementById('confirmModal'));
            modal.show();
            document.getElementById('confirmAction').onclick = async () => {
                try {
                    const response = await fetch(`/api/admin/admins/${id}`, {
                        method: 'DELETE',
                        headers: { 'Authorization': `Bearer ${token}` }
                    });
                    if (response.status === 401 || response.status === 403) {
                        localStorage.removeItem('token');
                        window.location.href = 'index.html';
                        return;
                    }
                    if (!response.ok) throw new Error('Erro ao excluir administrador');
                    modal.hide();
                    loadAdmins();
                } catch (error) {
                    showError('admins', error.message);
                }
            };
        }

        socket.on('authenticated', () => {
            console.log('Autenticado no Socket.IO');
            loadChatTabs();
        });

        socket.on('chatMessage', (data) => {
            const currentRecipient = localStorage.getItem('currentChatRecipient');
            if (data.from === currentRecipient || data.to === currentRecipient) {
                loadChatHistory(currentRecipient);
            }
        });

        socket.on('requestAdmin', async (data) => {
            try {
                const response = await fetch('/api/users/students', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                if (!response.ok) throw new Error('Erro ao carregar alunos');
                const students = await response.json();
                const student = students.find(s => s.username === data.from);
                if (student) {
                    const tabs = document.getElementById('chatTabs');
                    const existingTab = Array.from(tabs.children).find(tab => tab.querySelector('a').textContent === student.name);
                    if (!existingTab) {
                        const li = document.createElement('li');
                        li.className = 'nav-item';
                        li.innerHTML = `
                            <a class="nav-link" href="#" onclick="loadChatHistory('${student.username}')">${student.name}</a>
                        `;
                        tabs.appendChild(li);
                        document.getElementById('supportContent').innerHTML = '';
                    }
                    loadChatHistory(student.username);
                    document.querySelectorAll('#chatTabs .nav-link').forEach(tab => {
                        tab.classList.remove('active');
                        if (tab.textContent === student.name) {
                            tab.classList.add('active');
                        }
                    });
                }
            } catch (error) {
                showError('support', error.message);
            }
        });

        socket.on('error', (error) => {
            console.error('Erro de conexão Socket.IO:', error);
            showError('support', error.message || 'Erro de conexão com o servidor de chat');
        });

        socket.on('newTask', (task) => {
            loadTasks();
            loadOverview();
            loadReports();
        });

        socket.on('taskUpdated', (task) => {
            loadTasks();
            loadOverview();
            loadReports();
        });

        socket.on('newNotification', (notification) => {
            if (document.getElementById('notifications').classList.contains('d-none')) return;
            loadNotifications();
        });

        function logout() {
            localStorage.removeItem('token');
            localStorage.removeItem('userName');
            window.location.href = 'index.html';
        }

        loadOverview();
        loadTasks();
        loadAdmins();
        loadReports();
        loadNotifications();
        loadStudentsForTask();
    </script>
</body>
</html>